<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculateur de Bonus Sportifs</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0a0d14;
      --surface: #111520;
      --surface2: #181e2f;
      --border: rgba(255,255,255,0.07);
      --gold: #f0c040;
      --gold2: #c89a28;
      --green: #2ee89a;
      --red: #ff5c5c;
      --blue: #4da8f7;
      --text: #e8eaf0;
      --muted: #7880a0;
      --accent-a: #4da8f7;
      --accent-b: #2ee89a;
      --accent-c: #ff8c5c;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Background texture */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 80% 40% at 20% 10%, rgba(77,168,247,0.06) 0%, transparent 60%),
        radial-gradient(ellipse 60% 40% at 80% 80%, rgba(46,232,154,0.05) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }

    .wrap {
      position: relative;
      z-index: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px 20px 80px;
    }

    @media(max-width: 1440px) {
      .wrap { max-width: 1200px; }
    }

    @media(max-width: 1240px) {
      .wrap { max-width: 100%; padding: 40px 30px 80px; }
    }

    @media(max-width: 768px) {
      .wrap { padding: 30px 20px 60px; }
    }

    /* Header */
    header {
      text-align: center;
      margin-bottom: 48px;
    }

    .header-badge {
      display: inline-block;
      background: linear-gradient(135deg, rgba(240,192,64,0.15), rgba(240,192,64,0.05));
      border: 1px solid rgba(240,192,64,0.3);
      color: var(--gold);
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      letter-spacing: 3px;
      text-transform: uppercase;
      padding: 6px 16px;
      border-radius: 2px;
      margin-bottom: 16px;
    }

    h1 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(52px, 8vw, 80px);
      letter-spacing: 3px;
      line-height: 1;
      background: linear-gradient(135deg, #fff 0%, var(--muted) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 12px;
    }

    .subtitle {
      color: var(--muted);
      font-size: 15px;
      font-weight: 300;
    }

    /* Bookies controls with inline conversion rate */
    .bookies-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      margin-bottom: 28px;
      flex-wrap: wrap;
    }

    .controls-left {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .controls-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .inline-label {
      font-size: 11px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--muted);
      white-space: nowrap;
    }

    .inline-input-group {
      position: relative;
      display: flex;
      align-items: center;
      width: 120px;
    }

    .inline-input-group .number-input-wrapper {
      width: 100%;
    }

    .inline-input-group input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 15px;
      font-weight: 500;
      padding: 10px 60px 10px 12px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      -webkit-appearance: none;
      -moz-appearance: textfield;
    }

    .inline-input-group input::-webkit-inner-spin-button,
    .inline-input-group input::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .inline-input-group input:focus {
      border-color: rgba(240,192,64,0.5);
      box-shadow: 0 0 0 3px rgba(240,192,64,0.1);
    }

    .inline-unit {
      position: absolute;
      right: 28px;
      font-family: 'DM Mono', monospace;
      font-size: 13px;
      color: var(--muted);
      pointer-events: none;
    }
    .bookies-table-container {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .bookies-table {
      width: 100%;
      border-collapse: collapse;
    }

    .bookies-table thead {
      background: var(--surface2);
    }

    .bookies-table th {
      padding: 14px 16px;
      text-align: left;
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 600;
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
    }

    .bookies-table tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }

    .bookies-table tbody tr:hover {
      background: rgba(255,255,255,0.02);
    }

    .bookies-table tbody tr:last-child {
      border-bottom: none;
    }

    .bookies-table td {
      padding: 12px 16px;
      vertical-align: middle;
    }

    .bookies-table .td-num {
      width: 60px;
      text-align: center;
    }

    .bookie-num-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 13px;
      letter-spacing: 2px;
      color: var(--muted);
    }

    .bookies-table .td-name {
      min-width: 150px;
    }

    .bookies-table .td-outcome {
      min-width: 150px;
    }

    .bookies-table .td-odds {
      width: 120px;
    }

    .bookies-table .td-bonus {
      min-width: 200px;
    }

    .bookies-table .td-min {
      width: 120px;
    }

    .bookies-table .td-max {
      width: 120px;
    }

    .bookies-table input[type="text"],
    .bookies-table input[type="number"],
    .bookies-table select {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      padding: 10px 12px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      -webkit-appearance: none;
      -moz-appearance: textfield;
    }

    .bookies-table input[type="number"]::-webkit-inner-spin-button,
    .bookies-table input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .bookies-table input[type="number"] {
      font-family: 'DM Mono', monospace;
      font-size: 15px;
      font-weight: 500;
    }

    /* Number input with +/- controls */
    .number-input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .number-input-wrapper input {
      flex: 1;
      padding-right: 60px; /* Space for buttons and unit */
    }

    .number-controls {
      position: absolute;
      right: 2px;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .number-btn {
      width: 24px;
      height: 18px;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      user-select: none;
    }

    .number-btn:hover {
      background: var(--surface);
      color: var(--text);
      border-color: rgba(240,192,64,0.3);
    }

    .number-btn:active {
      background: var(--bg);
    }

    .number-btn.btn-up {
      border-radius: 0 6px 0 0;
      border-bottom: none;
    }

    .number-btn.btn-down {
      border-radius: 0 0 6px 0;
    }

    /* Adjust unit position when controls are present */
    .number-input-wrapper .input-unit {
      right: 28px;
    }

    .bookies-table input:focus,
    .bookies-table select:focus {
      border-color: rgba(240,192,64,0.5);
      box-shadow: 0 0 0 3px rgba(240,192,64,0.1);
    }

    .bookies-table select {
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237880a0' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    .bookies-table select option {
      background: var(--surface2);
      color: var(--text);
      padding: 8px 12px;
    }

    /* Custom styling for bonus type indicators */
    .bonus-select-wrapper {
      position: relative;
      display: block;
    }

    .bonus-dot {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      border-radius: 50%;
      pointer-events: none;
      z-index: 1;
    }

    .bonus-dot[data-bonus="freebet_lose"] {
      background: var(--blue);
      box-shadow: 0 0 6px rgba(77,168,247,0.6);
    }

    .bonus-dot[data-bonus="freebet_always"] {
      background: var(--green);
      box-shadow: 0 0 6px rgba(46,232,154,0.6);
    }

    .bonus-dot[data-bonus="cash_lose"] {
      background: #ff9d3d;
      box-shadow: 0 0 6px rgba(255,157,61,0.6);
    }

    .bonus-dot[data-bonus="cash_always"] {
      background: var(--gold);
      box-shadow: 0 0 6px rgba(240,192,64,0.6);
    }

    .bonus-dot[data-bonus="no_bonus"] {
      background: var(--muted);
      box-shadow: 0 0 4px rgba(120,128,160,0.4);
    }

    .bonus-select-wrapper select {
      padding-left: 28px;
    }

    .td-bonus select {
      position: relative;
    }

    .input-with-unit {
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-with-unit input {
      flex: 1;
      min-width: 0;
      padding-right: 32px;
    }

    .input-unit {
      position: absolute;
      right: 12px;
      font-family: 'DM Mono', monospace;
      font-size: 13px;
      color: var(--muted);
      pointer-events: none;
    }

    @media(max-width: 1100px) {
      .bookies-table-container {
        overflow-x: auto;
      }

      .bookies-table {
        min-width: 900px;
      }
    }

    @media(max-width: 680px) {
      .bookies-table th,
      .bookies-table td {
        padding: 10px 12px;
        font-size: 12px;
      }
    }

    /* Button styles */
    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-ghost:hover { border-color: rgba(255,255,255,0.2); color: var(--text); }

    /* Calculate button */
    .btn-calc {
      display: block;
      width: 100%;
      background: linear-gradient(135deg, var(--gold2) 0%, var(--gold) 100%);
      color: #0a0d14;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 22px;
      letter-spacing: 3px;
      border: none;
      border-radius: 12px;
      padding: 18px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 30px rgba(240,192,64,0.25);
      margin-bottom: 40px;
    }

    .btn-calc:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 40px rgba(240,192,64,0.35);
    }

    .btn-calc:active { transform: translateY(0); }

    /* Results */
    #results {
      display: none;
      animation: fadeUp 0.4s ease;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .results-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 32px;
      letter-spacing: 3px;
      color: var(--muted);
      margin-bottom: 20px;
    }

    /* Summary metrics */
    .metric-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .metric-label {
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .metric-value {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 36px;
      letter-spacing: 1px;
      color: var(--text);
      line-height: 1;
    }

    .metric-value.pos { color: var(--green); }
    .metric-value.neg { color: var(--red); }

    /* Stakes table */
    .stakes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 14px;
      margin-bottom: 24px;
    }

    @media(max-width: 680px) {
      .stakes-grid { grid-template-columns: 1fr; }
    }

    .stake-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .stake-bookie {
      font-size: 11px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .stake-name {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .stake-amount {
      font-family: 'DM Mono', monospace;
      font-size: 28px;
      font-weight: 500;
      color: var(--gold);
      margin-bottom: 4px;
    }

    .stake-outcome {
      font-size: 12px;
      color: var(--muted);
    }

    /* Outcome breakdown table */
    .breakdown {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .breakdown-table-container {
      overflow-x: auto;
    }

    .breakdown-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .breakdown-table thead {
      background: var(--surface2);
    }

    .breakdown-table th {
      padding: 16px 20px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid var(--border);
    }

    .th-site {
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      min-width: 180px;
      position: sticky;
      left: 0;
      background: var(--surface2);
      z-index: 2;
    }

    .th-outcome {
      min-width: 200px;
      text-align: center;
    }

    .th-outcome-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .th-outcome-sub {
      font-size: 11px;
      color: var(--muted);
      font-weight: 400;
    }

    .breakdown-table tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }

    .breakdown-table tbody tr:hover {
      background: rgba(255,255,255,0.02);
    }

    .breakdown-table tbody tr:last-child {
      border-bottom: none;
    }

    .site-row .td-site {
      position: sticky;
      left: 0;
      background: var(--surface);
      z-index: 1;
    }

    .site-row:hover .td-site {
      background: rgba(255,255,255,0.02);
    }

    .td-site {
      padding: 16px 20px;
      border-right: 1px solid var(--border);
    }

    .site-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .site-meta {
      font-size: 11px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
    }

    .td-outcome {
      padding: 12px 16px;
      text-align: left;
    }

    .td-outcome.win {
      background: rgba(46,232,154,0.03);
    }

    .td-outcome.lose {
      background: rgba(255,255,255,0.01);
    }

    .detail-line {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      padding: 4px 0;
    }

    .detail-line.total-line {
      margin-top: 6px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
    }

    .detail-lbl {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .detail-val {
      font-family: 'DM Mono', monospace;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
    }

    .detail-val.strong {
      font-size: 14px;
      font-weight: 600;
    }

    .detail-val.muted {
      color: var(--muted);
    }

    .pos { color: var(--green); }
    .neg { color: var(--red); }
    .neut { color: var(--blue); }

    .total-row {
      background: var(--surface2);
      font-weight: 600;
    }

    .total-row .td-site {
      background: var(--surface2);
      position: sticky;
      left: 0;
      z-index: 1;
    }

    .total-label .site-name {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 16px;
      letter-spacing: 2px;
      color: var(--gold);
    }

    .total-cell {
      background: var(--surface2) !important;
      border-top: 2px solid var(--border);
    }

    .total-cell .detail-line {
      padding: 5px 0;
    }

    @media(max-width: 900px) {
      .breakdown-table {
        font-size: 12px;
      }
      
      .th-outcome, .td-outcome {
        min-width: 180px;
      }

      .detail-lbl {
        font-size: 10px;
      }

      .detail-val {
        font-size: 12px;
      }
    }

    /* Error */
    .error-box {
      background: rgba(255,92,92,0.08);
      border: 1px solid rgba(255,92,92,0.25);
      border-radius: 10px;
      padding: 16px 20px;
      color: var(--red);
      font-size: 14px;
      margin-bottom: 20px;
    }

    /* Tooltip */
    .tip {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    hr.divider {
      border: none;
      border-top: 1px solid var(--border);
      margin: 32px 0;
    }

    @media(max-width: 500px) {
      .breakdown-details { gap: 10px; }
      
      .metric-value {
        font-size: 32px;
      }

      .bookies-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .controls-left {
        width: 100%;
      }

      .controls-right {
        width: 100%;
        justify-content: space-between;
      }

      .inline-input-group {
        width: 120px;
      }
    }
  </style>
</head>
<body>
<div class="wrap">

  <header>
    <h1>Calculateur Welcome Bonus</h1>
  </header>

  <!-- Bookie configuration -->
  <div id="bookies-container"></div>

  <!-- Controls -->
  <div class="bookies-controls">
    <div class="controls-left">
      <button class="btn-ghost" onclick="addBookie()">+ Ajouter un site</button>
      <button class="btn-ghost" onclick="removeBookie()">− Retirer le dernier</button>
    </div>
    <div class="controls-right">
      <label class="inline-label">Taux de conversion freebet</label>
      <div class="inline-input-group">
        <div class="number-input-wrapper">
          <input type="number" id="convRate" value="80" min="1" max="100" step="1" onclick="this.select()"/>
          <span class="inline-unit">%</span>
          <div class="number-controls">
            <button class="number-btn btn-up" onclick="incrementConvRate()" type="button">▲</button>
            <button class="number-btn btn-down" onclick="decrementConvRate()" type="button">▼</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Calculate -->
  <button class="btn-calc" onclick="calculate()">⚡ CALCULER LES MISES</button>

  <!-- Results -->
  <div id="results">
    <div class="results-title">RÉSULTATS</div>
    <div id="error-container"></div>
    <div id="gain-banner"></div>
    <div id="stakes-grid" class="stakes-grid"></div>
    <div id="breakdown-container"></div>
  </div>

</div>

<script>
  const COLORS = ['card-a','card-b','card-c','card-d','card-e'];
  const COLOR_VARS = ['--accent-a','--accent-b','--accent-c','--accent-d','--accent-e'];
  const EXTRA_COLORS = ['#c97ff5','#f7c44d'];
  const LABELS = ['Site A','Site B','Site C','Site D','Site E'];

  let bookies = [];

  function makeBookie(i) {
    const defaults = [
      { name: 'Site 1', outcome: 'Issue 1', odds: 2, bonus: 'freebet_always', min: 100, maxBonus: 100 },
      { name: 'Site 2', outcome: 'Issue 2', odds: 3.5, bonus: 'freebet_lose', min: 100, maxBonus: 100 },
      { name: 'Site 3', outcome: 'Issue 3', odds: 3.5, bonus: 'freebet_lose', min: 100, maxBonus: 100 },
    ];
    return defaults[i] || { name: `Site ${i+1}`, outcome: 'Issue ' + (i+1), odds: 2.0, bonus: 'freebet_lose', min: 100, maxBonus: 100 };
  }

  function init() {
    for (let i = 0; i < 3; i++) bookies.push(makeBookie(i));
    renderBookies();
  }

  function addBookie() {
    if (bookies.length >= 5) return;
    bookies.push(makeBookie(bookies.length));
    renderBookies();
  }

  function removeBookie() {
    if (bookies.length <= 2) return;
    bookies.pop();
    renderBookies();
  }

  function renderBookies() {
    const container = document.getElementById('bookies-container');
    const accentColors = ['var(--accent-a)','var(--accent-b)','var(--accent-c)','#c97ff5','#f7c44d'];

    container.innerHTML = `
      <div class="bookies-table-container">
        <table class="bookies-table">
          <thead>
            <tr>
              <th class="th-num">#</th>
              <th>Nom du site</th>
              <th>Issue couverte</th>
              <th>Cote</th>
              <th>Type de bonus</th>
              <th>Mise min</th>
              <th>Bonus max</th>
            </tr>
          </thead>
          <tbody>
            ${bookies.map((b, i) => `
              <tr>
                <td class="td-num">
                  <div class="bookie-num-badge">
                    <div style="width:8px;height:8px;border-radius:50%;background:${accentColors[i]};box-shadow:0 0 6px ${accentColors[i]}"></div>
                    ${i + 1}
                  </div>
                </td>
                <td class="td-name">
                  <input type="text" value="${b.name}" oninput="bookies[${i}].name=this.value" onclick="this.select()" placeholder="Ex: Betclic"/>
                </td>
                <td class="td-outcome">
                  <input type="text" value="${b.outcome}" oninput="bookies[${i}].outcome=this.value" onclick="this.select()" placeholder="Ex: Équipe gagne"/>
                </td>
                <td class="td-odds">
                  <div class="number-input-wrapper">
                    <input type="number" id="odds-${i}" value="${b.odds}" step="0.01" min="1.01" oninput="bookies[${i}].odds=parseFloat(this.value)||1" onclick="this.select()"/>
                    <div class="number-controls">
                      <button class="number-btn btn-up" onclick="incrementOdds(${i})" type="button">▲</button>
                      <button class="number-btn btn-down" onclick="decrementOdds(${i})" type="button">▼</button>
                    </div>
                  </div>
                </td>
                <td class="td-bonus">
                  <div class="bonus-select-wrapper">
                    <span class="bonus-dot bonus-dot-${i}" data-bonus="${b.bonus}"></span>
                    <select onchange="bookies[${i}].bonus=this.value; updateBonusDot(${i}, this.value)">
                      <option value="freebet_lose" ${b.bonus==='freebet_lose'?'selected':''}>Freebet si perdant</option>
                      <option value="freebet_always" ${b.bonus==='freebet_always'?'selected':''}>Freebet toujours</option>
                      <option value="cash_lose" ${b.bonus==='cash_lose'?'selected':''}>Cash si perdant</option>
                      <option value="cash_always" ${b.bonus==='cash_always'?'selected':''}>Cash toujours</option>
                      <option value="no_bonus" ${b.bonus==='no_bonus'?'selected':''}>Sans bonus</option>
                    </select>
                  </div>
                </td>
                <td class="td-min">
                  <div class="number-input-wrapper">
                    <input type="number" id="min-${i}" value="${b.min}" step="1" min="0" oninput="bookies[${i}].min=parseFloat(this.value)||0" onclick="this.select()"/>
                    <span class="input-unit">€</span>
                    <div class="number-controls">
                      <button class="number-btn btn-up" onclick="incrementMin(${i})" type="button">▲</button>
                      <button class="number-btn btn-down" onclick="decrementMin(${i})" type="button">▼</button>
                    </div>
                  </div>
                </td>
                <td class="td-max">
                  <div class="number-input-wrapper">
                    <input type="number" id="max-${i}" value="${b.maxBonus}" step="1" min="0" oninput="bookies[${i}].maxBonus=parseFloat(this.value)||0" onclick="this.select()"/>
                    <span class="input-unit">€</span>
                    <div class="number-controls">
                      <button class="number-btn btn-up" onclick="incrementMax(${i})" type="button">▲</button>
                      <button class="number-btn btn-down" onclick="decrementMax(${i})" type="button">▼</button>
                    </div>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  }

  function incrementOdds(i) {
    const input = document.getElementById(`odds-${i}`);
    const val = parseFloat(input.value) || 1.01;
    const newVal = Math.round((val + 0.01) * 100) / 100;
    input.value = newVal;
    bookies[i].odds = newVal;
  }

  function decrementOdds(i) {
    const input = document.getElementById(`odds-${i}`);
    const val = parseFloat(input.value) || 1.01;
    const newVal = Math.max(1.01, Math.round((val - 0.01) * 100) / 100);
    input.value = newVal;
    bookies[i].odds = newVal;
  }

  function incrementMin(i) {
    const input = document.getElementById(`min-${i}`);
    const val = parseFloat(input.value) || 0;
    const newVal = val + 10;
    input.value = newVal;
    bookies[i].min = newVal;
  }

  function decrementMin(i) {
    const input = document.getElementById(`min-${i}`);
    const val = parseFloat(input.value) || 0;
    const newVal = Math.max(0, val - 10);
    input.value = newVal;
    bookies[i].min = newVal;
  }

  function incrementMax(i) {
    const input = document.getElementById(`max-${i}`);
    const val = parseFloat(input.value) || 0;
    const newVal = val + 10;
    input.value = newVal;
    bookies[i].maxBonus = newVal;
  }

  function decrementMax(i) {
    const input = document.getElementById(`max-${i}`);
    const val = parseFloat(input.value) || 0;
    const newVal = Math.max(0, val - 10);
    input.value = newVal;
    bookies[i].maxBonus = newVal;
  }

  function updateBonusDot(index, bonusType) {
    const dot = document.querySelector(`.bonus-dot-${index}`);
    if (dot) {
      dot.setAttribute('data-bonus', bonusType);
    }
  }

  function incrementConvRate() {
    const input = document.getElementById('convRate');
    const val = parseFloat(input.value) || 80;
    const newVal = Math.min(100, val + 1);
    input.value = newVal;
  }

  function decrementConvRate() {
    const input = document.getElementById('convRate');
    const val = parseFloat(input.value) || 80;
    const newVal = Math.max(1, val - 1);
    input.value = newVal;
  }

  function fmt(v, decimals=2) {
    return v.toLocaleString('fr-FR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
  }

  function calculate() {
    const convRate = (parseFloat(document.getElementById('convRate').value) || 80) / 100;

    // Re-read all values from the DOM - from table rows
    const rows = document.querySelectorAll('.bookies-table tbody tr');
    rows.forEach((row, i) => {
      const inputs = row.querySelectorAll('input, select');
      // order: name(0), outcome(1), odds(2), bonus(3), min(4), maxBonus(5)
      bookies[i].name     = inputs[0].value;
      bookies[i].outcome  = inputs[1].value;
      bookies[i].odds     = parseFloat(inputs[2].value) || 1.01;
      bookies[i].bonus    = inputs[3].value;
      bookies[i].min      = parseFloat(inputs[4].value) || 0;
      bookies[i].maxBonus = parseFloat(inputs[5].value) || 0;
    });

    const n = bookies.length;

    /*
     * ITERATIVE SOLVER — handles capped bonuses (freebet and cash)
     *
     * For site j, the actual bonus (in cash) when losing = effectiveConv * min(stake_j, maxBonus_j)
     * - For freebet: effectiveConv = convRate (e.g., 80%)
     * - For cash: effectiveConv = 100%
     *
     * When bonus = '*_always', same bonus is also received when winning.
     *
     * We define two regimes per site:
     *   UNCAPPED  (stake_j <= maxBonus_j):
     *     - lose:     effective = -stake_j + effectiveConv*stake_j  = -(1-effectiveConv)*stake_j
     *     - win gain: (odds_j-1)*stake_j + (always? effectiveConv*stake_j : 0)
     *   CAPPED  (stake_j > maxBonus_j):
     *     - lose:     effective = -stake_j + effectiveConv*maxBonus_j   [constant bonus]
     *     - win gain: (odds_j-1)*stake_j + (always? effectiveConv*maxBonus_j : 0)
     */

    // Calculate effective conversion rate per site
    const effectiveConv = bookies.map(b => {
      if (b.bonus === 'no_bonus') return 0;
      if (b.bonus === 'cash_lose' || b.bonus === 'cash_always') return 1; // 100% for cash
      return convRate; // freebet uses user-defined conversion rate
    });

    let capped = bookies.map(() => false);
    let stakes = null;

    for (let iter = 0; iter < 20; iter++) {
      // Build coefficients for each site based on current capped state
      const winCoef = bookies.map((b, j) => {
        // cash profit from winning bet
        if (b.bonus === 'no_bonus' || b.bonus === 'freebet_lose' || b.bonus === 'cash_lose') {
          return b.odds - 1;
        }
        // *_always: win includes bonus
        return capped[j] ? (b.odds - 1) : (b.odds - 1 + effectiveConv[j]);
      });

      const winConst = bookies.map((b, j) => {
        if ((b.bonus === 'freebet_always' || b.bonus === 'cash_always') && capped[j]) {
          return effectiveConv[j] * b.maxBonus;
        }
        return 0;
      });

      const loseCoef = bookies.map((b, j) => {
        if (b.bonus === 'no_bonus') return -1;
        return capped[j] ? -1 : -(1 - effectiveConv[j]);
      });

      const loseConst = bookies.map((b, j) => {
        if (b.bonus === 'no_bonus') return 0;
        return capped[j] ? effectiveConv[j] * b.maxBonus : 0;
      });

      const eff = bookies.map((b, j) => winCoef[j] - loseCoef[j]);
      const C   = bookies.map((b, j) => winConst[j] - loseConst[j]);

      if (bookies.some((b, j) => Math.abs(eff[j]) < 1e-9)) {
        showError("Calcul impossible : vérifiez vos cotes et vos types de bonus.");
        return;
      }

      // Express all stakes in terms of s0
      let s0 = bookies[0].min || 1;
      for (let k = 1; k < n; k++) {
        const minK = bookies[k].min || 0;
        const needed = (eff[k] * minK - C[0] + C[k]) / eff[0];
        if (needed > s0) s0 = needed;
      }
      if (s0 < (bookies[0].min || 0)) s0 = bookies[0].min || 0;

      const candidate = bookies.map((b, j) => {
        if (j === 0) return s0;
        return (eff[0] * s0 + C[0] - C[j]) / eff[j];
      });

      if (candidate.some(s => s < -0.01)) {
        showError("Impossible d'équilibrer les mises avec ces paramètres. Vérifiez les cotes et les bonus.");
        return;
      }

      // Update capped status
      let changed = false;
      bookies.forEach((b, j) => {
        if (b.bonus === 'no_bonus' || b.maxBonus <= 0) return;
        const shouldCap = candidate[j] > b.maxBonus + 0.01;
        if (shouldCap !== capped[j]) { capped[j] = shouldCap; changed = true; }
      });

      stakes = candidate;
      if (!changed) break;
    }

    if (!stakes) { showError("Erreur de calcul interne."); return; }

    // Compute actual gains using real bonus amounts (min(stake, maxBonus))
    const bonusAmount = (b, s, bIdx) => {
      if (b.bonus === 'no_bonus') return 0;
      return effectiveConv[bIdx] * Math.min(s, b.maxBonus > 0 ? b.maxBonus : s);
    };

    const gains = bookies.map((b, outcomeIdx) => {
      let g = 0;
      bookies.forEach((bk, j) => {
        const s = stakes[j];
        if (j === outcomeIdx) {
          g += (bk.odds - 1) * s;
          if (bk.bonus === 'freebet_always' || bk.bonus === 'cash_always') {
            g += bonusAmount(bk, s, j);
          }
        } else {
          g += -s + bonusAmount(bk, s, j);
        }
      });
      return g;
    });

    const totalStaked = stakes.reduce((a, b) => a + b, 0);
    const avgGain = gains.reduce((a, b) => a + b, 0) / gains.length;
    const roi = (avgGain / totalStaked) * 100;

    showResults({ stakes, gains, avgGain, totalStaked, roi, convRate, effectiveConv, capped, bonusAmount });
  }

  function showError(msg) {
    document.getElementById('results').style.display = 'block';
    document.getElementById('error-container').innerHTML = `<div class="error-box">⚠️ ${msg}</div>`;
    document.getElementById('gain-banner').innerHTML = '';
    document.getElementById('stakes-grid').innerHTML = '';
    document.getElementById('breakdown-container').innerHTML = '';
  }

  function showResults({ stakes, gains, avgGain, totalStaked, roi, convRate, effectiveConv, capped, bonusAmount }) {
    document.getElementById('error-container').innerHTML = '';
    document.getElementById('results').style.display = 'block';

    // Summary metrics (4 values side by side)
    document.getElementById('gain-banner').innerHTML = `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
        <div class="metric-card">
          <div class="metric-label">Total misé</div>
          <div class="metric-value">${fmt(totalStaked)} €</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Gain net</div>
          <div class="metric-value ${avgGain >= 0 ? 'pos' : 'neg'}">${fmt(avgGain)} €</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Total garanti</div>
          <div class="metric-value pos">${fmt(totalStaked + avgGain)} €</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">ROI</div>
          <div class="metric-value ${roi >= 0 ? 'pos' : 'neg'}">${fmt(roi, 1)} %</div>
        </div>
      </div>
    `;

    // Stakes cards
    const accentColors = ['var(--accent-a)','var(--accent-b)','var(--accent-c)','#c97ff5','#f7c44d'];

    document.getElementById('stakes-grid').innerHTML = bookies.map((b, i) => {
      const capNote = capped[i] ? `<div class="stake-outcome" style="color:var(--gold);margin-top:4px">⚠ Bonus plafonné à ${fmt(b.maxBonus)} €</div>` : '';
      return `
        <div class="stake-card" style="border-color: ${accentColors[i]}28">
          <div class="stake-bookie" style="color:${accentColors[i]}">${b.name}</div>
          <div class="stake-name">${b.outcome}</div>
          <div class="stake-amount">${fmt(stakes[i])} €</div>
          <div class="stake-outcome">@ cote ${fmt(b.odds,2)}</div>
          ${capNote}
        </div>
      `;
    }).join('');

    // Helper to determine if bonus is cash type
    const isCashBonus = (bonus) => bonus === 'cash_lose' || bonus === 'cash_always';

    // Breakdown with issues as columns and sites as rows
    const tableHTML = `
      <div class="breakdown">
        <div class="breakdown-table-container">
          <table class="breakdown-table">
            <thead>
              <tr>
                <th class="th-site">Site / Bookmaker</th>
                ${bookies.map((b, idx) => `
                  <th class="th-outcome">
                    <div class="th-outcome-title">${b.outcome}</div>
                    <div class="th-outcome-sub">${b.name} gagne @ ${fmt(b.odds)}</div>
                  </th>
                `).join('')}
              </tr>
            </thead>
            <tbody>
              ${bookies.map((site, siteIdx) => {
                const s = stakes[siteIdx];
                const bonusRaw = (site.bonus === 'no_bonus') ? 0 : Math.min(s, site.maxBonus > 0 ? site.maxBonus : s);
                const bonusCash = bonusAmount(site, s, siteIdx);
                const isCash = isCashBonus(site.bonus);

                return `
                  <tr class="site-row">
                    <td class="td-site">
                      <div class="site-name">${site.name}</div>
                      <div class="site-meta">Mise: ${fmt(s)} €${capped[siteIdx] ? ' <span style="color:var(--gold)">⚠</span>' : ''}</div>
                    </td>
                    ${bookies.map((outcome, outcomeIdx) => {
                      const wins = siteIdx === outcomeIdx;
                      
                      if (wins) {
                        // Site wins
                        const cashProfit = (site.odds - 1) * s;
                        const hasAlwaysBonus = (site.bonus === 'freebet_always' || site.bonus === 'cash_always');
                        const bonusIfWin = hasAlwaysBonus ? bonusCash : 0;
                        const total = cashProfit + bonusIfWin;
                        
                        if (isCash) {
                          // Cash bonus display
                          return `
                            <td class="td-outcome win">
                              <div class="detail-line">
                                <span class="detail-lbl">Cash:</span>
                                <span class="detail-val pos">+${fmt(cashProfit)} €</span>
                              </div>
                              <div class="detail-line">
                                <span class="detail-lbl">Bonus cash:</span>
                                <span class="detail-val ${bonusIfWin > 0 ? 'neut' : 'muted'}">+${fmt(bonusIfWin)} €</span>
                              </div>
                              <div class="detail-line total-line">
                                <span class="detail-lbl">Total:</span>
                                <span class="detail-val pos strong">+${fmt(total)} €</span>
                              </div>
                            </td>
                          `;
                        } else {
                          // Freebet display
                          const fbRaw = hasAlwaysBonus ? bonusRaw : 0;
                          const fbConverted = bonusIfWin;
                          return `
                            <td class="td-outcome win">
                              <div class="detail-line">
                                <span class="detail-lbl">Cash:</span>
                                <span class="detail-val pos">+${fmt(cashProfit)} €</span>
                              </div>
                              <div class="detail-line">
                                <span class="detail-lbl">Freebet brut:</span>
                                <span class="detail-val ${fbRaw > 0 ? 'neut' : 'muted'}">+${fmt(fbRaw)} €</span>
                              </div>
                              <div class="detail-line">
                                <span class="detail-lbl">Freebet @ ${Math.round(convRate*100)}%:</span>
                                <span class="detail-val ${fbConverted > 0 ? 'neut' : 'muted'}">+${fmt(fbConverted)} €</span>
                              </div>
                              <div class="detail-line total-line">
                                <span class="detail-lbl">Total:</span>
                                <span class="detail-val pos strong">+${fmt(total)} €</span>
                              </div>
                            </td>
                          `;
                        }
                      } else {
                        // Site loses
                        const cashLoss = -s;
                        const total = cashLoss + bonusCash;
                        
                        if (isCash) {
                          // Cash bonus display
                          return `
                            <td class="td-outcome lose">
                              <div class="detail-line">
                                <span class="detail-lbl">Cash:</span>
                                <span class="detail-val neg">${fmt(cashLoss)} €</span>
                              </div>
                              <div class="detail-line">
                                <span class="detail-lbl">Bonus cash:</span>
                                <span class="detail-val ${bonusCash > 0 ? 'neut' : 'muted'}">+${fmt(bonusCash)} €</span>
                              </div>
                              <div class="detail-line total-line">
                                <span class="detail-lbl">Total:</span>
                                <span class="detail-val ${total >= 0 ? 'neut' : 'neg'} strong">${fmt(total)} €</span>
                              </div>
                            </td>
                          `;
                        } else {
                          // Freebet display
                          return `
                            <td class="td-outcome lose">
                              <div class="detail-line">
                                <span class="detail-lbl">Cash:</span>
                                <span class="detail-val neg">${fmt(cashLoss)} €</span>
                              </div>
                              <div class="detail-line">
                                <span class="detail-lbl">Freebet brut:</span>
                                <span class="detail-val ${bonusRaw > 0 ? 'neut' : 'muted'}">+${fmt(bonusRaw)} €</span>
                              </div>
                              <div class="detail-line">
                                <span class="detail-lbl">Freebet @ ${Math.round(convRate*100)}%:</span>
                                <span class="detail-val ${bonusCash > 0 ? 'neut' : 'muted'}">+${fmt(bonusCash)} €</span>
                              </div>
                              <div class="detail-line total-line">
                                <span class="detail-lbl">Total:</span>
                                <span class="detail-val ${total >= 0 ? 'neut' : 'neg'} strong">${fmt(total)} €</span>
                              </div>
                            </td>
                          `;
                        }
                      }
                    }).join('')}
                  </tr>
                `;
              }).join('')}
              
              <!-- Total row -->
              <tr class="total-row">
                <td class="td-site total-label">
                  <div class="site-name">TOTAL</div>
                </td>
                ${bookies.map((outcome, outcomeIdx) => {
                  // Calculate totals for this outcome
                  let totalCash = 0;
                  let totalFreebetRaw = 0;
                  let totalFreebetConverted = 0;
                  let totalCashBonus = 0;
                  let hasCashBonus = false;
                  let hasFreebetBonus = false;
                  
                  bookies.forEach((site, siteIdx) => {
                    const s = stakes[siteIdx];
                    const bonusRaw = (site.bonus === 'no_bonus') ? 0 : Math.min(s, site.maxBonus > 0 ? site.maxBonus : s);
                    const bonusCash = bonusAmount(site, s, siteIdx);
                    const wins = siteIdx === outcomeIdx;
                    const isCash = isCashBonus(site.bonus);
                    
                    if (isCash && site.bonus !== 'no_bonus') hasCashBonus = true;
                    if (!isCash && site.bonus !== 'no_bonus') hasFreebetBonus = true;
                    
                    if (wins) {
                      totalCash += (site.odds - 1) * s;
                      if (site.bonus === 'freebet_always' || site.bonus === 'cash_always') {
                        if (isCash) {
                          totalCashBonus += bonusCash;
                        } else {
                          totalFreebetRaw += bonusRaw;
                          totalFreebetConverted += bonusCash;
                        }
                      }
                    } else {
                      totalCash += -s;
                      if (isCash) {
                        totalCashBonus += bonusCash;
                      } else {
                        totalFreebetRaw += bonusRaw;
                        totalFreebetConverted += bonusCash;
                      }
                    }
                  });
                  
                  const total = totalCash + totalFreebetConverted + totalCashBonus;
                  
                  // Build lines conditionally
                  let lines = '';
                  
                  // Cash line (always)
                  lines += '<div class="detail-line">';
                  lines += '<span class="detail-lbl">Cash:</span>';
                  lines += '<span class="detail-val '+(totalCash >= 0 ? 'pos' : 'neg')+' strong">'+fmt(totalCash)+' €</span>';
                  lines += '</div>';
                  
                  // Freebet lines (only if freebet bonuses exist)
                  if (hasFreebetBonus) {
                    lines += '<div class="detail-line">';
                    lines += '<span class="detail-lbl">Freebet brut:</span>';
                    lines += '<span class="detail-val '+(totalFreebetRaw > 0 ? 'neut' : 'muted')+' strong">+'+fmt(totalFreebetRaw)+' €</span>';
                    lines += '</div>';
                    lines += '<div class="detail-line">';
                    lines += '<span class="detail-lbl">Freebet @ '+Math.round(convRate*100)+'%:</span>';
                    lines += '<span class="detail-val '+(totalFreebetConverted > 0 ? 'neut' : 'muted')+' strong">+'+fmt(totalFreebetConverted)+' €</span>';
                    lines += '</div>';
                  }
                  
                  // Cash bonus line (only if cash bonuses exist)
                  if (hasCashBonus) {
                    lines += '<div class="detail-line">';
                    lines += '<span class="detail-lbl">Cash bonus:</span>';
                    lines += '<span class="detail-val '+(totalCashBonus > 0 ? 'neut' : 'muted')+' strong">+'+fmt(totalCashBonus)+' €</span>';
                    lines += '</div>';
                  }
                  
                  // Total line (always)
                  lines += '<div class="detail-line total-line">';
                  lines += '<span class="detail-lbl">Total:</span>';
                  lines += '<span class="detail-val '+(total >= 0 ? 'pos' : 'neg')+' strong">'+fmt(total)+' €</span>';
                  lines += '</div>';
                  
                  return `
                    <td class="td-outcome total-cell">
                      ${lines}
                    </td>
                  `;
                }).join('')}
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      ${capped.some(Boolean) ? `<p class="tip" style="margin-top:10px">⚠ = bonus plafonné au maximum du site</p>` : ''}
    `;
    
    document.getElementById('breakdown-container').innerHTML = tableHTML;

    document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  init();
</script>
</body>
</html>
